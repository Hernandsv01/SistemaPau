/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package editors;

import enums.ConfirmType;
import java.awt.Color;
import java.util.List;
import javax.swing.JTable;
import tools.Clase;
import tools.ConfirmMessage;
import tools.DBConnection;
import tools.PopupMessage;
import main.ViewerClaseSemanal;

/**
 *
 * @author Edu
 */
public class EditorClaseSemanal extends javax.swing.JFrame {

    private String ID;
    private String titulo;
    private String diasemana;
    private String horario;
    private String duracion;
    private String frecuencia;
    private String cantidad;
    private String tematica;
    
    private boolean changedID = false;
    private String newID;
    private List<String[]> clasesalumnos;
    private List<String[]> tematicaclases;
    
    private ViewerClaseSemanal VCS;
    private javax.swing.JTable tablasemanal;
    
    /**
     * Creates new form EditorClaseSemanal
     */
    public EditorClaseSemanal() {
        initComponents();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        btnaplicar = new javax.swing.JButton();
        btneliminar = new javax.swing.JButton();
        jLabel13 = new javax.swing.JLabel();
        boxhorario = new javax.swing.JComboBox<>();
        boxdia = new javax.swing.JComboBox<>();
        jLabel11 = new javax.swing.JLabel();
        jScrollPane7 = new javax.swing.JScrollPane();
        txttematica = new javax.swing.JTextPane();
        boxduracion = new javax.swing.JComboBox<>();
        jLabel8 = new javax.swing.JLabel();
        jLabel12 = new javax.swing.JLabel();
        jLabel9 = new javax.swing.JLabel();
        txttitulo = new javax.swing.JTextField();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);

        btnaplicar.setText("Aplicar cambios");
        btnaplicar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnaplicarActionPerformed(evt);
            }
        });

        btneliminar.setBackground(new java.awt.Color(255, 0, 0));
        btneliminar.setText("Eliminar clase");
        btneliminar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btneliminarActionPerformed(evt);
            }
        });

        jLabel13.setText("Duración:");

        boxhorario.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "08:00", "08:30", "09:00", "09:30", "10:00", "10:30", "11:00", "11:30", "12:00", "12:30", "13:00", "13:30", "14:00", "14:30", "15:00", "15:30", "16:00", "16:30", "17:00", "17:30", "18:00", "18:30", "19:00", "19:30" }));

        boxdia.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "Lunes", "Martes", "Miercoles", "Jueves", "Viernes", "Sabado" }));

        jLabel11.setText("Temática");

        jScrollPane7.setViewportView(txttematica);

        boxduracion.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "00:30", "01:00", "01:30", "02:00", "02:30", "03:00" }));

        jLabel8.setText("Horario: ");

        jLabel12.setText("Titulo:");

        jLabel9.setText("Dia de la semana:");

        txttitulo.setToolTipText("00:00");

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addContainerGap(417, Short.MAX_VALUE)
                .addComponent(btneliminar, javax.swing.GroupLayout.PREFERRED_SIZE, 236, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(34, 34, 34)
                .addComponent(btnaplicar, javax.swing.GroupLayout.PREFERRED_SIZE, 236, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(51, 51, 51))
            .addGroup(layout.createSequentialGroup()
                .addGap(51, 51, 51)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jLabel9)
                    .addComponent(jLabel8)
                    .addComponent(jLabel11)
                    .addComponent(jLabel12)
                    .addComponent(jLabel13))
                .addGap(46, 46, 46)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(txttitulo, javax.swing.GroupLayout.PREFERRED_SIZE, 246, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(boxdia, javax.swing.GroupLayout.PREFERRED_SIZE, 134, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jScrollPane7, javax.swing.GroupLayout.PREFERRED_SIZE, 694, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING, false)
                        .addComponent(boxhorario, javax.swing.GroupLayout.Alignment.LEADING, 0, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(boxduracion, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(36, 36, 36)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel12)
                    .addComponent(txttitulo, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(18, 18, 18)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel8)
                    .addComponent(boxhorario, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(19, 19, 19)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel13)
                    .addComponent(boxduracion, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(20, 20, 20)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel9)
                    .addComponent(boxdia, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 43, Short.MAX_VALUE)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jLabel11)
                    .addComponent(jScrollPane7, javax.swing.GroupLayout.PREFERRED_SIZE, 196, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(42, 42, 42)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btnaplicar, javax.swing.GroupLayout.PREFERRED_SIZE, 49, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(btneliminar, javax.swing.GroupLayout.PREFERRED_SIZE, 49, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(39, 39, 39))
        );

        pack();
        setLocationRelativeTo(null);
    }// </editor-fold>//GEN-END:initComponents

    private void btnaplicarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnaplicarActionPerformed
        boolean isFirst = true;
        boolean diaCambiado = false;
        boolean horaCambiada = false;
        
        String newTitulo = txttitulo.getText().trim().toUpperCase();
        String newHorario = boxhorario.getSelectedItem().toString();
        String newDuracion = boxduracion.getSelectedItem().toString();
        String newDia = boxdia.getSelectedItem().toString();
        String newTematica = txttematica.getText().trim();
        
        String[] doselementos = newHorario.split(":");
        newID = Clase.generateClassID(newDia, doselementos[0], doselementos[1]);
        
        if(newTitulo.length() >= 15){
            new PopupMessage("Error - titulo demasiado largo", Color.RED).setVisible(true);
            return;
        }
        
        //Formar String con valores cambiados
        String statement = "UPDATE `clasesemanal` SET ";
        
        if(!newTitulo.equals(titulo)){
            statement += "`titulo` = '" + newTitulo + "' ";
            isFirst = false;
        }
        if(!newHorario.equals(horario)){
            if(!isFirst){
                statement += ", ";
            }
            statement += "`hora` = '" + newHorario + "' ";
            isFirst = false;
            horaCambiada = true;
        }
        if(!newDuracion.equals(duracion)){
            if(!isFirst){
                statement += ", ";
            }
            statement += "`duracion` = '" + newDuracion + "'";
            isFirst = false;
        }
        if(!newDia.equals(Clase.setClassValue(diasemana))){
            if(!isFirst){
                statement += ", ";
            }
            statement += "`diasemana` = '" + Clase.setDBValue(newDia) + "' ";
            isFirst = false;
            diaCambiado = true;
        }
        
        //Chequear si cambia el ID y borrar de clasealumnos
        if(horaCambiada || diaCambiado){
            List<String[]> listClase = DBConnection.getInstance().selectStatement("SELECT * FROM `clasesemanal`", 7);
            for(int i = 0; i < listClase.size(); i++){
                String[] str = listClase.get(i);
                if(newID.equals(str[0])){
                    new PopupMessage("Error - Clase superpuesta", Color.RED).setVisible(true);
                    return;
                }
            }
            
            if(!isFirst){
                statement += ", ";
            }
            statement += "`ID` = '" + newID + "' ";
            
            String selstatement1 = "SELECT * FROM `clasesalumnos` WHERE `id_clase` = '" + ID + "'";
            clasesalumnos = DBConnection.getInstance().selectStatement(selstatement1, 3);
            String selstatement2 = "SELECT * FROM `tematicaclases` WHERE `id_clase` = '" + ID + "'";
            tematicaclases = DBConnection.getInstance().selectStatement(selstatement2, 2);
            String delstatement1 = "DELETE FROM `clasesalumnos` WHERE `id_clase` = '" + ID + "'";
            DBConnection.getInstance().modificationStatement(delstatement1);
            String delstatement2 = "DELETE FROM `tematicaclases` WHERE `id_clase` = '" + ID + "'";
            DBConnection.getInstance().modificationStatement(delstatement2);
            
            changedID = true;
        }
        
        statement += "WHERE `clasesemanal`.`diasemana` = '" + diasemana + "' AND `clasesemanal`.`hora` = '" + horario + "'";
        
        if(!isFirst){
            if(!DBConnection.getInstance().modificationStatement(statement)){
                new PopupMessage("Error", Color.RED).setVisible(true);
            }
        }
        
        //Volver a agregar datos a clasesalumnos y tematicaclases
        if(changedID){
            for(int i = 0; i < clasesalumnos.size(); i++){
                String[] str = clasesalumnos.get(i);
                String instatement = "INSERT INTO `clasesalumnos` VALUES ('" + str[0] + "', '" + newID + "', '" + str[2] + "')";
                DBConnection.getInstance().modificationStatement(instatement);
            }
            for(int i = 0; i < tematicaclases.size(); i++){
                String[] str = tematicaclases.get(i);
                String instatement = "INSERT INTO `tematicaclases` VALUES ('" + newID + "', '" + str[1] + "')";
                DBConnection.getInstance().modificationStatement(instatement);
            }
        }
        
        if(!txttematica.getText().trim().equals(tematica)){
            String statement1;
            if(newTematica.equals("")){
                statement1 = "UPDATE `tematicaclases` SET `tematica` = null WHERE `id_clase` = '" + newID + "'";
            }else{
                statement1 = "UPDATE `tematicaclases` SET `tematica` = '" + newTematica + "' WHERE `id_clase` = '" + newID + "'";
            }
            DBConnection.getInstance().modificationStatement(statement1);
        }
        
        //Agregar chequeo de superposicion de clase con duracion
        
        new PopupMessage("Clase actualizada con exito", Color.GREEN).setVisible(true);
        dispose();
        VCS.dispose();
    }//GEN-LAST:event_btnaplicarActionPerformed

    private void btneliminarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btneliminarActionPerformed
        ConfirmMessage cm = new ConfirmMessage();
        cm.setECS(this);
        cm.setVCS(VCS);
        cm.setClase(diasemana, horario);
        cm.setType(ConfirmType.E_CLASESEMANAL);
        cm.setVisible(true);
    }//GEN-LAST:event_btneliminarActionPerformed

    /**
     * @param args the command line arguments
     */
    @SuppressWarnings("Convert2Lambda")
    public static void main2(String args[]) {
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ClassNotFoundException | InstantiationException | IllegalAccessException | javax.swing.UnsupportedLookAndFeelException ex) {
            java.util.logging.Logger.getLogger(EditorClaseSemanal.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>
        //</editor-fold>

        /* Create and display the form */
        java.awt.EventQueue.invokeLater(new Runnable() {
            @Override
            public void run() {
                new EditorClaseSemanal().setVisible(true);
            }
        });
    }
    
    public void setBox(){
        boxhorario.setSelectedItem(horario);
        boxduracion.setSelectedItem(duracion);
        boxdia.setSelectedItem(Clase.setClassValue(diasemana));
        
    }
    
    public void setVCS(ViewerClaseSemanal VCS){
        this.VCS = VCS;
    }
    
    public void setInfo(String[] infoClase){
        this.ID = infoClase[0];
        System.out.println("ID: " + ID);
        this.titulo = infoClase[1];
        System.out.println("Titulo: " + titulo);
        this.diasemana = infoClase[2];
        System.out.println("Dia Semana: " + diasemana);
        this.horario = infoClase[3].split(":")[0] + ":" + infoClase[3].split(":")[1];
        System.out.println("Horario: " + horario);
        this.duracion = infoClase[4];
        System.out.println("Duracion: " + duracion);
        this.frecuencia = infoClase[5];
        System.out.println("Frecuencia: " + frecuencia);
        this.cantidad = infoClase[6];
        System.out.println("Cantidad: " + cantidad);
        this.tematica = infoClase[8];
        System.out.println("Tematica: " + tematica);
        
        txttitulo.setText(titulo);
        setBox();
        txttematica.setText(tematica);
        
    }
    
    public void setTabla(JTable tablasemanal) {
        this.tablasemanal = tablasemanal;
        }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JComboBox<String> boxdia;
    private javax.swing.JComboBox<String> boxduracion;
    private javax.swing.JComboBox<String> boxhorario;
    private javax.swing.JButton btnaplicar;
    private javax.swing.JButton btneliminar;
    private javax.swing.JLabel jLabel11;
    private javax.swing.JLabel jLabel12;
    private javax.swing.JLabel jLabel13;
    private javax.swing.JLabel jLabel8;
    private javax.swing.JLabel jLabel9;
    private javax.swing.JScrollPane jScrollPane7;
    private javax.swing.JTextPane txttematica;
    private javax.swing.JTextField txttitulo;
    // End of variables declaration//GEN-END:variables

}
